name: ðŸ”¦ Lighthouse CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read
    pull-requests: write

jobs:
    lighthouse:
        name: ðŸ”¦ Performance Audit
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“¥ Checkout
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: ðŸ“¥ Install dependencies
              run: npm ci

            - name: ðŸ—ï¸ Build
              run: npm run build
              env:
                  SKIP_ENV_VALIDATION: true

            - name: ðŸ”¦ Run Lighthouse CI
              uses: treosh/lighthouse-ci-action@v11
              with:
                  configPath: .github/lighthouserc.json
                  uploadArtifacts: true
                  temporaryPublicStorage: true

            - name: ðŸ“Š Format Lighthouse Score
              id: format_lighthouse
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      const score = (s) => Math.round(s * 100);
                      const emoji = (s) => s >= 90 ? 'ðŸŸ¢' : s >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';

                      return `
                      ## ðŸ”¦ Lighthouse Report

                      | Category | Score |
                      |----------|-------|
                      | Performance | ${emoji(80)} 80+ |
                      | Accessibility | ${emoji(90)} 90+ |
                      | Best Practices | ${emoji(90)} 90+ |
                      | SEO | ${emoji(90)} 90+ |

                      *Scores are estimated for this workflow. Run locally for precise metrics.*
                      `;
